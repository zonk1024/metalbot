<html>
<head>
<title>\m/ Andy's Metalbot \m/</title>
<link rel="stylesheet" href="/static/css/jqtree.css" />
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/static/js/tree.jquery.js"></script>
<script type="text/javascript">
    function populateArtists()
    {
        $.get("/api/artists", "", function(data, status) {
            var artistTree = [];

            $.each(data, function() {
                var artist = { label: this["artist"], children: []};

                $.each(this["albums"], function() {
                    artist["children"].push({label: this["album"] });
                });

                artistTree.push(artist);
            });

            $(".albums").tree({
                data: artistTree,
                onCanSelectNode: function(node) {
                    if (node.children.length > 0)
                        return false;
                    return true;
                }
            });

        });
    }

    function createBindings()
    {
        $(".albums").bind("tree.select", function(event) {
            var node = event.node;
            artist = node.parent.name;
            album = node.name;
            $.get("/api/songs/" + artist + "/" + album, "", function(data, status) {
                var songlist = [];

                $.each(data, function() {
                    songlist.push({label: "[" + this["id"] + "] " + this["title"]});
                });
                $(".songs").tree({
                    data: songlist
                });
                $("#queuesong").css("display", "");
                $("#queuealbum").css("display", "");
                $("#queuealbum").data("currentalbum", artist + "/" + album);
            });
        });

        $(".songs").bind ("tree.select", function(event) {
            var node = event.node;

            var regex = /\[(\d+)\]/;
            id = regex.exec(node.name);
            if (id[1])
                $("#queuesong").data("currentsong", id[1]);
        });
    }

    function getQueue()
    {
        $.get("/api/queue", "", function(data, status) {
            $("#queue").html("");
            $.each(data, function() {
                $("#queue").append("<li>[" + this["sid"] + "] <b>" + this["artist"] + "</b> - <i>" + this["title"] + "</i></li>");
            });
        });
        setTimeout(getQueue, 10000);
    }

    $(function() {
        populateArtists();
        createBindings();

        $("#queuesong").click(function(e) {
            id = $(this).data("currentsong");
            if (id)
            {
                $.get("/api/queue/" + id, "", function(data, status){
                    getQueue();
                });
            }
        });

        $("#queuealbum").click(function(e) {
            if (!confirm("Confirm the whole damn album? That's a lot of " + artist + "..."))
                return;

            id = $(this).data("currentalbum");
            if (id)
            {
                $.get("/api/queue/" + id, "", function(data, status){
                    getQueue();
                });
            }
        });

        getQueue();
    });
</script>
<style type="text/css">
body
{
    font-family: courier;
    background-color: #000000;
    color: #FFFFFF;
}

div.evil
{
    border: 1px solid red;
    padding-left: 10px;
    padding-top: 10px;
    padding-bottom: 10px;
}

.cover
{
    width: 100px;
    height: 100px;
}

.albums
{
    height: 500px;
    overflow: auto;
}

.songs
{
    height: 150px;
    overflow: auto;
}

.jqtree-title 
{
    color: #ffffff !important;
}

td { vertical-align: top; width: 33%; }
ul { list-style-type: none; }

ul.jqtree-tree li.jqtree-selected > div,
ul.jqtree-tree li.jqtree-selected > div:hover {
    background-color: #FF6817;
    background: -webkit-gradient(linear, left top, left bottom, from(#FF6A00), to(#FA0C00));
    background: -moz-linear-gradient(top, #FF6A00, #FA0C00);
    background: -ms-linear-gradient(top,  #FF6A00, #FA0C00);
    background: -o-linear-gradient(top,  #FF6A00, #FA0C00);
    text-shadow: 0 1px 0 rgba(255, 255, 255, 0.7);
}

h2 { width: 100%; text-align: center; }

</style>
</head>
<body>
<h2>\m/ Andy's MetalBot \m/</h2>
<table border=0 width="100%">
<tr>
    <td>
        <div class="evil">
        <h3>Albums</h3>
        <div class="albums"></div>
        </div>
        <div class="evil">
        <h3>Songs</h3>
        <div class="songs"></div>
        </div>
        <div class="buttons">
            <input type="button" id="queuesong" value="Queue Song" style="display: none" />
            <input type="button" id="queuealbum" value="Queue Album" style="display: none" />
        </div>
    </td>
    <td>
        <div class="evil">
        <h3>Now Playing</h3>
        {% if nowplaying.coverpath %}
        <img class="cover" src="{{nowplaying.coverpath}}" />
        <br >
        {% endif %}
        [{{nowplaying.sid}}] <b>{{nowplaying.artist}}</b> - <i>{{nowplaying.title}}</i><br />
        From the "{{nowplaying.album}}" album
        </div>
        <div class="evil">
        <h3>Upcoming Tracks</h3>
        <ol>
        {% if nextup.length == 0 %}
        No upcoming tracks.
        {% else %}
        {% for song in nextup %}
        <li>[{{song.sid}}] <b>{{song.artist}}</b> - <i>{{song.title}}</i></li>
        {% endfor %}
        </ol>
        {% endif %}
        </div>
    </td>
    <td>
        <div class="evil">
        <h3>Queue</h3>
        <ol id="queue">
        </ol>
        </div>
    </td>
</tr>
</body>
